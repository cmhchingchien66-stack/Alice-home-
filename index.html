<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ æ•æ·æ€ç¶­ç ”è¨æœƒå ±åè¡¨å–®</title>
    <!-- å¼•å…¥ Tailwind CSS for modern styling and responsiveness -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the vibrant background gradient */
        body {
            /* Lively gradient: Red-Orange to Teal-Blue */
            background-color: #f0fdfa; /* Fallback color */
            background-image: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%);
            font-family: 'Inter', sans-serif;
        }

        /* Container card styling */
        .card-container {
            max-width: 960px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 24px; /* More rounded corners */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            animation: bounceIn 1s ease-out;
        }

        /* Animation for a lively entrance */
        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            60% { transform: scale(1.03); opacity: 1; }
            100% { transform: scale(1); }
        }

        /* Highlight color definitions */
        .color-primary { color: #FF6B6B; }
        .bg-primary { background-color: #FF6B6B; }
        .color-secondary { color: #4ECDC4; }
        .bg-secondary { background-color: #4ECDC4; }

        /* Specific styles for the agenda table */
        .agenda-table th {
            background-color: #4ECDC4;
            color: white;
            border-bottom: 2px solid #3bb3aa;
        }
        .agenda-table tr:nth-child(even) {
            background-color: #f0fdfa; /* Very light teal */
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal/Message Box Styling */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 30px;
            border-radius: 12px;
            z-index: 1000;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease-out;
            opacity: 0;
            visibility: hidden;
        }
        .message-box.show {
            opacity: 1;
            visibility: visible;
        }
        .message-box.success {
            background-color: #e6fffa; /* Tailwind Green-100 */
            border: 2px solid #38b2ac; /* Tailwind Teal-500 */
            color: #2c7a7b; /* Tailwind Teal-800 */
        }
        .message-box.error {
            background-color: #fff5f5; /* Tailwind Red-100 */
            border: 2px solid #f56565; /* Tailwind Red-500 */
            color: #9b2c2c; /* Tailwind Red-800 */
        }
    </style>
</head>
<body>

    <div class="card-container">
        <!-- Header Section -->
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold color-primary mb-2 animate-pulse">
                ğŸ‰ æ•æ·æ€ç¶­å°å…¥æ•™å­¸è¡Œæ”¿ ğŸ‰
            </h1>
            <h2 class="text-xl md:text-2xl color-secondary font-semibold">
                Hello World 2025 é–‹ç™¼è€…å¤§æœƒå¿ƒå¾—åˆ†äº«æš¨å¯¦å‹™ç ”è¨æœƒ
            </h2>
        </header>

        <!-- I. æ´»å‹•è³‡è¨Š -->
        <section class="mb-8 p-6 bg-green-50/50 rounded-xl border-l-4 border-secondary shadow-inner">
            <h3 class="text-2xl font-bold color-primary mb-4 border-b-2 border-dashed border-red-300 pb-2">
                æ´»å‹•è³‡è¨Š (Activity Info)
            </h3>
            <p class="mb-4 text-gray-700">
                <strong>ç›®çš„ï¼š</strong> åˆ†äº«ã€Œæ•æ·é–‹ç™¼ (Agile)ã€çš„æ ¸å¿ƒç²¾ç¥ï¼Œä¸¦å…±åŒæ¢è¨å¦‚ä½•å°‡å…¶æ‡‰ç”¨æ–¼æ•™å­¸éƒ¨çš„æ—¥å¸¸è¡Œæ”¿ã€å°ˆæ¡ˆç®¡ç† (å¦‚ QCCã€OSCE ç±Œå‚™) ä¸­ï¼Œä»¥æå‡åœ˜éšŠæ•ˆç‡èˆ‡æ‡‰è®Šèƒ½åŠ›ã€‚
            </p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-lg font-medium">
                <div class="flex items-center text-gray-700">
                    <span class="color-secondary mr-2 text-2xl">ğŸ“…</span>
                    <strong>æ—¥æœŸï¼š</strong> 2025 å¹´ 11 æœˆ 30 æ—¥ (æ—¥)
                </div>
                <div class="flex items-center text-gray-700">
                    <span class="color-secondary mr-2 text-2xl">â°</span>
                    <strong>æ™‚é–“ï¼š</strong> 14:00 - 17:00 (å…± 3 å°æ™‚)
                </div>
                <div class="flex items-center text-gray-700">
                    <span class="color-secondary mr-2 text-2xl">ğŸ“</span>
                    <strong>åœ°é»ï¼š</strong> ç¬¬äº”é†«ç™‚å¤§æ¨“5F552æœƒè­°å®¤
                </div>
            </div>
        </section>

        <!-- II. æ´»å‹•è­°ç¨‹ - å¢åŠ  TTS åŠŸèƒ½ -->
        <section class="mb-8 p-6 bg-red-50/50 rounded-xl border-l-4 border-primary shadow-inner">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold color-primary border-b-2 border-dashed border-red-300 pb-2 inline-block">
                    æ´»å‹•è­°ç¨‹ (Agenda)
                </h3>
                <button id="ttsButton" onclick="generateTts()" 
                        class="flex items-center py-2 px-4 bg-secondary text-white font-bold rounded-full text-sm hover:bg-teal-500 transition duration-300">
                    <span id="ttsText">ğŸ—£ï¸ æœ—è®€è­°ç¨‹</span>
                    <div id="ttsSpinner" class="hidden spinner ml-2"></div>
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table id="agendaTable" class="agenda-table w-full text-left rounded-lg overflow-hidden shadow-md">
                    <thead>
                        <tr>
                            <th class="p-3 text-sm uppercase tracking-wider rounded-tl-lg w-1/4">æ™‚é–“</th>
                            <th class="p-3 text-sm uppercase tracking-wider rounded-tr-lg w-3/4">å…§å®¹</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="p-3 font-semibold color-primary">14:00 - 14:15</td>
                            <td class="p-3">å ±åˆ°èˆ‡æš–èº« (Check-in) é ˜å–åç‰Œã€äº«ç”¨èŒ¶é»ï¼Œä¸¦é€éç°¡å–®çš„ç ´å†°éŠæˆ²èªè­˜è·¨éƒ¨é–€å¤¥ä¼´ã€‚</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-semibold color-primary">14:15 - 15:00</td>
                            <td class="p-3">Session 1: æ“æŠ±è®ŠåŒ–çš„å‹‡æ°£ å¾ Hello World 2025 é–‹ç™¼è€…å¤§æœƒçœ‹è¦‹è¶¨å‹¢ã€‚ä»€éº¼æ˜¯ Agileï¼Ÿç‚ºä»€éº¼åŸæœ¬ç”¨æ–¼è»Ÿé«”é–‹ç™¼çš„æ€ç¶­ï¼Œèƒ½è§£æ±ºè¡Œæ”¿å·¥ä½œçš„ç—›é»ï¼Ÿ</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-semibold color-primary">15:00 - 15:10</td>
                            <td class="p-3 bg-yellow-100/70 font-medium">ä¸­å ´ä¼‘æ¯ (Break) å¤§è…¦å……é›»èˆ‡è‡ªç”±äº¤æµæ™‚é–“ã€‚</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-semibold color-primary">15:10 - 16:00</td>
                            <td class="p-3">Session 2: è¡Œæ”¿å¯¦å‹™æ‡‰ç”¨æ¡ˆä¾‹ ä¸å†è¢« Deadline è¿½è‘—è·‘ï¼åˆ†äº«å¦‚ä½•åˆ©ç”¨ã€Œè¦–è¦ºåŒ–çœ‹æ¿ (Kanban)ã€èˆ‡ã€Œè¿­ä»£ (Iteration)ã€ä¾†å„ªåŒ– QCC å°ˆæ¡ˆèˆ‡ OSCE è€ƒè©¦ç±Œå‚™æµç¨‹ã€‚</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-semibold color-primary">16:00 - 16:40</td>
                            <td class="p-3">Workshop: æ•æ·å¯¦æˆ°æ¼”ç·´ åˆ†çµ„å·¥ä½œåŠï¼šé‡å°ç›®å‰çš„è¡Œæ”¿ç—›é»ï¼Œå¯¦éš›æ¼”ç·´ä¸€æ¬¡ã€Œç«™ç«‹æœƒè­° (Daily Stand-up)ã€èˆ‡ã€Œå›é¡§æœƒè­° (Retrospective)ã€ã€‚</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-semibold color-primary">16:40 - 17:00</td>
                            <td class="p-3">ç¸½çµèˆ‡å•ç­” (Q&A) é–‹æ”¾æå•èˆ‡è¬›å¸«ç¸½çµã€‚</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <audio id="ttsAudio" controls class="hidden w-full mt-4"></audio>
        </section>

        <!-- III. å ±åè¡¨å–® - å¢åŠ  LLM ç”Ÿæˆ Q&A ç¯„ä¾‹ -->
        <section class="p-6 bg-white rounded-xl shadow-lg border-t-8 border-secondary">
            <h3 class="text-2xl font-bold color-secondary mb-6 border-b-2 border-secondary pb-2">
                <span class="text-3xl mr-2">ğŸ“</span> åŸºæœ¬è³‡æ–™èˆ‡æå• (Registration & Inquiry)
            </h3>
            
            <!-- ä¿®æ”¹è¡¨å–®: ç§»é™¤ action/method, æ”¹ç”¨ onsubmit å‘¼å« JavaScript è™•ç† -->
            <form id="registrationForm" onsubmit="handleSubmit(event)" class="space-y-6">
                <!-- å§“å -->
                <div>
                    <label for="name" class="block text-lg font-medium text-gray-700 mb-2">
                        å§“å <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="name" name="name" required
                           class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-primary focus:ring-4 focus:ring-red-200 transition duration-300"
                           placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
                </div>

                <!-- é›»å­éƒµä»¶ -->
                <div>
                    <label for="email" class="block text-lg font-medium text-gray-700 mb-2">
                        é›»å­éƒµä»¶ (Email) <span class="text-red-500">*</span>
                    </label>
                    <input type="email" id="email" name="email" required
                           class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-primary focus:ring-4 focus:ring-red-200 transition duration-300"
                           placeholder="example@hospital.com.tw">
                </div>

                <!-- å–®ä½ -->
                <div>
                    <label for="unit" class="block text-lg font-medium text-gray-700 mb-2">
                        å–®ä½ <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="unit" name="unit" required
                           class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-primary focus:ring-4 focus:ring-red-200 transition duration-300"
                           placeholder="è«‹è¼¸å…¥æ‚¨çš„æœå‹™å–®ä½/éƒ¨é–€">
                </div>

                <!-- è·ç¨± -->
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-2">
                        è·ç¨± (å¿…å¡«) <span class="text-red-500">*</span>
                    </label>
                    <div class="flex flex-wrap gap-x-6 gap-y-3">
                        <!-- Radio buttons for Title -->
                        <!-- ç¢ºä¿æ‰€æœ‰ Radio Button çš„ name å±¬æ€§éƒ½ç‚º 'jobTitle' -->
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="jobTitle" value="é†«å¸«" required class="form-radio h-5 w-5 text-secondary accent-secondary">
                            <span class="ml-2 text-gray-700">é†«å¸«</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="jobTitle" value="è­·ç†å¸«" class="form-radio h-5 w-5 text-secondary accent-secondary">
                            <span class="ml-2 text-gray-700">è­·ç†å¸«</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="jobTitle" value="é†«äº‹äººå“¡" class="form-radio h-5 w-5 text-secondary accent-secondary">
                            <span class="ml-2 text-gray-700">é†«äº‹äººå“¡</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="jobTitle" value="è¡Œæ”¿äººå“¡" class="form-radio h-5 w-5 text-secondary accent-secondary">
                            <span class="ml-2 text-gray-700">è¡Œæ”¿äººå“¡</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="jobTitle" value="å…¶ä»–" class="form-radio h-5 w-5 text-secondary accent-secondary">
                            <span class="ml-2 text-gray-700">å…¶ä»–</span>
                        </label>
                    </div>
                </div>

                <!-- æ˜¯å¦éœ€è¦èŒ¶æ°´é»å¿ƒ -->
                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-2">
                        æ˜¯å¦éœ€è¦èŒ¶æ°´é»å¿ƒï¼Ÿ <span class="text-red-500">*</span>
                    </label>
                    <div class="flex flex-wrap gap-x-6 gap-y-3">
                         <!-- ç¢ºä¿æ‰€æœ‰ Radio Button çš„ name å±¬æ€§éƒ½ç‚º 'snackNeeded' -->
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="snackNeeded" value="æ˜¯" required class="form-radio h-5 w-5 text-primary accent-primary">
                            <span class="ml-2 text-gray-700 font-semibold">æ˜¯ (éœ€è¦)</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="snackNeeded" value="å¦" class="form-radio h-5 w-5 text-primary accent-primary">
                            <span class="ml-2 text-gray-700">å¦ (ä¸éœ€è¦)</span>
                        </label>
                    </div>
                </div>

                <!-- æœƒå‰æå• - å¢åŠ  LLM äº’å‹•å€ -->
                <div>
                    <label for="pre_question" class="block text-lg font-medium text-gray-700 mb-2">
                        æœƒå‰æå• (é¸å¡«)
                    </label>

                    <!-- LLM Generated Q&A Section -->
                    <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <button id="qnaButton" onclick="generateQnAExamples()" type="button" 
                                class="flex items-center py-2 px-4 bg-primary text-white font-bold rounded-xl text-sm hover:bg-red-500 transition duration-300">
                            <span id="qnaText">âœ¨ ç”Ÿæˆ Q&A ç¯„ä¾‹ (æ¿€ç™¼æå•éˆæ„Ÿ)</span>
                            <div id="qnaSpinner" class="hidden spinner ml-2 border-top-white border-white"></div>
                        </button>
                        <div id="qnaOutput" class="mt-3 text-sm text-gray-700 whitespace-pre-wrap"></div>
                    </div>

                    <textarea id="pre_question" name="preQuestion" rows="4"
                              class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-primary focus:ring-4 focus:ring-red-200 transition duration-300"
                              placeholder="è«‹å¡«å¯«æ‚¨çš„å•é¡Œã€‚ä¾‹å¦‚ï¼šæ•æ·æ€ç¶­å°å…¥è¡Œæ”¿æœƒå¢åŠ åˆæœŸè² æ“”å—ï¼Ÿ"></textarea>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitButton"
                        class="w-full py-4 bg-primary text-white font-bold text-xl rounded-xl shadow-lg hover:bg-red-500 transition duration-300 transform hover:scale-[1.01] hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-red-300">
                    ğŸš€ ç«‹å³å ±åï¼Œæå‡è¡Œæ”¿æ•ˆç‡ï¼
                </button>
            </form>
        </section>

        <!-- Footer Section -->
        <footer class="mt-8 pt-4 border-t border-gray-200 text-center text-sm text-gray-600">
            <p><strong>ä¸»è¾¦å–®ä½ï¼š</strong> å¥‡ç¾é†«é™¢æ•™å­¸éƒ¨</p>
            <p><strong>è¯çµ¡äººï¼š</strong> ç›§è‹±äº‘ (åˆ†æ©Ÿ57425)</p>
            <p class="mt-2 text-xs italic">
                æœ¬å ±åè³‡æ–™åƒ…ä¾›æœ¬æ¬¡ç ”è¨æœƒè¯ç¹«èˆ‡é¤é»çµ±è¨ˆä½¿ç”¨ï¼Œç¢ºä¿æ‚¨çš„å€‹äººè³‡è¨Šå®‰å…¨ç„¡è™ã€‚
            </p>
        </footer>
    </div>
    
    <!-- å ±åçµæœè¨Šæ¯æ¡† -->
    <div id="messageBox" class="message-box"></div>

<script>
    // --------------------------------------------------------------------------------
    // !!! Apps Script ç¶²é æ‡‰ç”¨ç¨‹å¼ URL (å·²ç¢ºèªç‚ºæ‚¨æä¾›çš„ç¶²å€) !!!
    // --------------------------------------------------------------------------------
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby1UAwdg29gaBCElJxzsBL5aHXVAklqRzNy7mu3nok9-MvxmNWkXL8cqgRUZqClanzFug/exec'; 
    
    // --- Gemini API Configuration and Utility Functions ---
    const API_URL_TEXT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=';
    const API_URL_TTS = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=';
    const apiKey = ""; 

    /** Utility functions for TTS and API (base64ToArrayBuffer, pcmToWav, fetchWithBackoff) kept for completeness */
    function base64ToArrayBuffer(base64) {
        const binaryString = atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    function pcmToWav(pcm16, sampleRate) {
        const numChannels = 1;
        const bitsPerSample = 16;
        const buffer = new ArrayBuffer(44 + pcm16.length * 2);
        const view = new DataView(buffer);
        let offset = 0;

        function writeString(s) {
            for (let i = 0; i < s.length; i++) {
                view.setUint8(offset + i, s.charCodeAt(i));
            }
            offset += s.length;
        }

        /* RIFF identifier */
        writeString('RIFF'); offset += 4;
        /* file length */
        view.setUint32(offset, 36 + pcm16.length * 2, true); offset += 4;
        /* RIFF type */
        writeString('WAVE'); offset += 4;
        /* format chunk identifier */
        writeString('fmt '); offset += 4;
        /* format chunk length */
        view.setUint32(offset, 16, true); offset += 4;
        /* sample format (1 for PCM) */
        view.setUint16(offset, 1, true); offset += 2;
        /* number of channels */
        view.setUint16(offset, numChannels, true); offset += 2;
        /* sample rate */
        view.setUint32(offset, sampleRate, true); offset += 4;
        /* byte rate (sample rate * block align) */
        view.setUint32(offset, sampleRate * numChannels * bitsPerSample / 8, true); offset += 4;
        /* block align (num channels * bits per sample / 8) */
        view.setUint16(offset, numChannels * bitsPerSample / 8, true); offset += 2;
        /* bits per sample */
        view.setUint16(offset, bitsPerSample, true); offset += 2;
        /* data chunk identifier */
        writeString('data'); offset += 4;
        /* data chunk length */
        view.setUint32(offset, pcm16.length * 2, true); offset += 4;

        // Write PCM data
        for (let i = 0; i < pcm16.length; i++) {
            view.setInt16(offset, pcm16[i], true);
            offset += 2;
        }

        return new Blob([view], { type: 'audio/wav' });
    }

    async function fetchWithBackoff(url, options, maxRetries = 5) {
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 || response.status >= 500) {
                    throw new Error(`Server error or rate limit hit: ${response.status}`);
                }
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({}));
                    console.error('API Error Response:', errorBody);
                    throw new Error(`API failed: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.warn(`Attempt ${attempt + 1} failed: ${error.message}. Retrying...`);
                if (attempt === maxRetries - 1) {
                    throw error;
                }
                const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }


    // --- Form Submission Handler ---

    const submitButton = document.getElementById('submitButton');
    const registrationForm = document.getElementById('registrationForm');
    const messageBox = document.getElementById('messageBox');
    
    /**
     * é¡¯ç¤ºè‡ªå®šç¾©è¨Šæ¯æ¡†
     * @param {string} message - è¦é¡¯ç¤ºçš„è¨Šæ¯
     * @param {string} type - è¨Šæ¯é¡å‹ ('success' or 'error')
     */
    function showMessage(message, type) {
        messageBox.textContent = message;
        messageBox.className = `message-box show ${type}`;
        
        // 5 ç§’å¾Œè‡ªå‹•éš±è—
        setTimeout(() => {
            messageBox.classList.remove('show');
        }, 5000);
    }

    /**
     * ç²å–é¸ä¸­çš„ Radio Button å€¼
     * @param {string} name - Radio Button çš„ name å±¬æ€§
     * @returns {string | null} é¸ä¸­çš„å€¼
     */
    function getSelectedRadioValue(name) {
        const radios = document.getElementsByName(name);
        for (let i = 0; i < radios.length; i++) {
            if (radios[i].checked) {
                return radios[i].value;
            }
        }
        return '';
    }

    /**
     * è™•ç†è¡¨å–®æäº¤
     * @param {Event} event - æäº¤äº‹ä»¶
     */
    async function handleSubmit(event) {
        event.preventDefault(); // é˜»æ­¢ç€è¦½å™¨é»˜èªçš„è¡¨å–®æäº¤è¡Œç‚º

        // æ”¶é›†è¡¨å–®è³‡æ–™ä¸¦æ‰‹å‹•æ§‹é€ èˆ‡ Apps Script æœŸæœ›æ ¼å¼åŒ¹é…çš„ç‰©ä»¶
        const data = {
            // æ³¨æ„ï¼šApps Script çš„ doPost(e) æœƒå°‡é€™äº›ä½œç‚ºåƒæ•¸åç¨±
            // è«‹ç¢ºä¿é€™äº›åç¨±èˆ‡ Apps Script ç¨‹å¼ç¢¼ä¸­å–çš„åç¨±ä¸€è‡´
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            unit: document.getElementById('unit').value,
            jobTitle: getSelectedRadioValue('jobTitle'), // ä½¿ç”¨æ›´æ–°å¾Œçš„ name å±¬æ€§
            snackNeeded: getSelectedRadioValue('snackNeeded'), // ä½¿ç”¨æ›´æ–°å¾Œçš„ name å±¬æ€§
            preQuestion: document.getElementById('pre_question').value // ä½¿ç”¨æ›´æ–°å¾Œçš„ name å±¬æ€§
        };
        
        // å°‡è³‡æ–™è½‰æ›ç‚º URLSearchParams
        const urlParams = new URLSearchParams();
        for (const key in data) {
            urlParams.append(key, data[key]);
        }

        // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        submitButton.disabled = true;
        submitButton.innerHTML = '<div class="spinner mx-auto border-top-white border-white"></div> å ±åè³‡æ–™å‚³é€ä¸­...';
        
        try {
            // ä½¿ç”¨ fetch ç™¼é€ POST è«‹æ±‚åˆ° Apps Script ç¶²å€
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors', 
                cache: 'no-cache',
                body: urlParams
            });

            // æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
            if (!response.ok) {
                 // å¦‚æœ HTTP ç‹€æ…‹ç¢¼ä¸æ˜¯ 200-299ï¼Œç›´æ¥æ‹‹å‡ºéŒ¯èª¤
                throw new Error(`HTTP éŒ¯èª¤ç‹€æ…‹ç¢¼: ${response.status}`);
            }

            // Apps Script æ‡‰è¿”å› JSON æ ¼å¼çš„å…§å®¹
            const result = await response.json();

            if (result.result === 'success') {
                showMessage('âœ… å ±åæˆåŠŸï¼æ„Ÿè¬æ‚¨çš„åƒèˆ‡ã€‚è³‡æ–™å·²å¯«å…¥è©¦ç®—è¡¨ã€‚', 'success');
                registrationForm.reset(); // æ¸…ç©ºè¡¨å–®
            } else {
                // Apps Script è™•ç†å¤±æ•— (ä¾‹å¦‚è©¦ç®—è¡¨åç¨±éŒ¯èª¤)
                throw new Error(result.message || 'Apps Script è¿”å›å¤±æ•—è¨Šæ¯ã€‚');
            }

        } catch (error) {
            console.error('æäº¤å ±åè¡¨ç™¼ç”ŸéŒ¯èª¤:', error);
            // å˜—è©¦è§£æéŒ¯èª¤è¨Šæ¯ï¼Œæä¾›æ›´å‹å–„çš„æç¤º
            let friendlyMessage = 'å ±åå¤±æ•—ï¼è«‹ç¢ºèª Apps Script å·²éƒ¨ç½²ä¸¦å…è¨±ã€Œä»»ä½•äººã€å­˜å–ã€‚';
            if (error.message.includes('HTTP éŒ¯èª¤ç‹€æ…‹ç¢¼: 404')) {
                 friendlyMessage = 'å ±åå¤±æ•—ï¼Apps Script ç¶²å€å¯èƒ½ä¸æ­£ç¢ºæˆ–æ‡‰ç”¨ç¨‹å¼ä¸å­˜åœ¨ã€‚';
            } else if (error.message.includes('Apps Script è¿”å›å¤±æ•—è¨Šæ¯')) {
                 friendlyMessage = `å ±åå¤±æ•—ï¼å¾Œç«¯éŒ¯èª¤ï¼š${error.message.split('å¾Œç«¯éŒ¯èª¤ï¼š')[1] || 'è«‹æª¢æŸ¥ Apps Script ç¨‹å¼ç¢¼ã€‚'}`;
            }

            showMessage(`âŒ ${friendlyMessage}`, 'error');
        } finally {
            // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
            submitButton.disabled = false;
            submitButton.innerHTML = 'ğŸš€ ç«‹å³å ±åï¼Œæå‡è¡Œæ”¿æ•ˆç‡ï¼';
        }
    }


    // --- Feature 1: Generate Q&A Examples (Unchanged) ---

    const qnaButton = document.getElementById('qnaButton');
    const qnaText = document.getElementById('qnaText');
    const qnaSpinner = document.getElementById('qnaSpinner');
    const qnaOutput = document.getElementById('qnaOutput');
    const activityPurpose = document.querySelector('p.mb-4 strong').parentElement.textContent;

    async function generateQnAExamples() {
        qnaButton.disabled = true;
        qnaText.textContent = 'ç”Ÿæˆä¸­...';
        qnaSpinner.classList.remove('hidden');
        qnaOutput.textContent = ''; // Clear previous output

        const userPrompt = `æ ¹æ“šä»¥ä¸‹ç ”è¨æœƒä¸»é¡Œå’Œç›®çš„ï¼Œè«‹ç”Ÿæˆä¸‰å€‹èˆ‡ã€Œæ•æ·æ€ç¶­å°å…¥è¡Œæ”¿ã€ç›¸é—œçš„å¸¸è¦‹å•é¡Œ (Q) åŠç°¡çŸ­çš„åƒè€ƒå›ç­” (A)ã€‚ç­”æ¡ˆéœ€ç‚ºç¹é«”ä¸­æ–‡ï¼Œä¸¦ä»¥ç´”æ–‡æœ¬æ ¼å¼è¼¸å‡ºï¼Œæ¯å€‹å•é¡Œå’Œå›ç­”ä¹‹é–“ç”¨ä¸€å€‹ç©ºè¡Œåˆ†éš”ï¼š\n\nä¸»é¡Œèˆ‡ç›®çš„: ${activityPurpose}`;
        
        const payload = {
            contents: [{ parts: [{ text: userPrompt }] }],
            systemInstruction: {
                parts: [{ text: "æ‚¨æ˜¯ä¸€ä½å°ˆæ¥­çš„è¡Œæ”¿ç®¡ç†é¡§å•ã€‚è«‹ä»¥å‹å–„ä¸”å¯¦ç”¨çš„èªæ°£ï¼Œé‡å°è¡Œæ”¿ç—›é»æä¾›æ•æ·è§£æ–¹ç›¸é—œçš„Q&Aã€‚" }]
            },
        };

        try {
            const result = await fetchWithBackoff(API_URL_TEXT + apiKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'æœªèƒ½ç”Ÿæˆç¯„ä¾‹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
            qnaOutput.textContent = text;

        } catch (error) {
            console.error('Error generating QnA:', error);
            qnaOutput.textContent = 'ğŸ˜µ ç™¼ç”ŸéŒ¯èª¤ï¼Œç„¡æ³•ç”Ÿæˆ Q&A ç¯„ä¾‹ã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚';
        } finally {
            qnaButton.disabled = false;
            qnaText.textContent = 'âœ¨ ç”Ÿæˆ Q&A ç¯„ä¾‹ (æ¿€ç™¼æå•éˆæ„Ÿ)';
            qnaSpinner.classList.add('hidden');
        }
    }


    // --- Feature 2: Agenda TTS (Text-to-Speech) (Unchanged) ---

    const ttsButton = document.getElementById('ttsButton');
    const ttsText = document.getElementById('ttsText');
    const ttsSpinner = document.getElementById('ttsSpinner');
    const ttsAudio = document.getElementById('ttsAudio');
    const agendaTable = document.getElementById('agendaTable');

    async function generateTts() {
        ttsButton.disabled = true;
        ttsText.textContent = 'æœ—è®€æº–å‚™ä¸­...';
        ttsSpinner.classList.remove('hidden');
        ttsAudio.classList.add('hidden');
        ttsAudio.pause();
        ttsAudio.src = '';
        
        // 1. Compile the full agenda text
        let ttsPrompt = "è«‹ç”¨æº«æš–ä¸”å…·æ´»åŠ›çš„èªæ°£ï¼Œæœ—è®€ä»¥ä¸‹ç ”è¨æœƒçš„æ´»å‹•è­°ç¨‹ï¼š\n\n";
        const rows = agendaTable.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const time = row.cells[0].textContent.trim();
            const content = row.cells[1].textContent.trim();
            ttsPrompt += `æ™‚é–“ ${time}ã€‚å…§å®¹ï¼š${content}ã€‚\n`;
        });
        
        // Use a suitable female voice (Aoede: Breezy/Lively) for the TTS model
        const payload = {
            contents: [{ parts: [{ text: ttsPrompt }] }],
            generationConfig: {
                responseModalities: ["AUDIO"],
                speechConfig: {
                    voiceConfig: {
                        prebuiltVoiceConfig: { voiceName: "Aoede" } // Using a lively voice
                    }
                }
            },
        };

        try {
            const result = await fetchWithBackoff(API_URL_TTS + apiKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                if (!sampleRateMatch) {
                    throw new Error("Missing sample rate in MIME type.");
                }
                const sampleRate = parseInt(sampleRateMatch[1], 10);
                
                // Convert base64 audio to WAV format
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                
                // Create object URL and play
                ttsAudio.src = URL.createObjectURL(wavBlob);
                ttsAudio.classList.remove('hidden');
                await ttsAudio.play();
                ttsText.textContent = 'ğŸ—£ï¸ æœ—è®€å®Œæˆ/å†è½ä¸€æ¬¡';
            } else {
                throw new Error("Invalid or missing audio data in response.");
            }

        } catch (error) {
            console.error('Error generating TTS:', error);
            ttsAudio.classList.remove('hidden');
            ttsAudio.controls = false;
            ttsAudio.parentElement.querySelector('#ttsText').textContent = 'âš ï¸ æœ—è®€å¤±æ•—';
            // Use a custom message box instead of alert()
            const messageBox = ttsAudio.parentElement.querySelector('#ttsOutput') || document.createElement('div');
            messageBox.id = 'ttsOutput';
            messageBox.className = 'mt-2 p-2 bg-red-100 text-red-700 rounded-lg text-sm';
            messageBox.textContent = 'éŸ³è¨Šç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚';
            if (!ttsAudio.parentElement.querySelector('#ttsOutput')) {
                ttsAudio.parentElement.insertBefore(messageBox, ttsAudio.nextSibling);
            }
        } finally {
            ttsButton.disabled = false;
            ttsSpinner.classList.add('hidden');
        }
    }
</script>

</body>
</html>
